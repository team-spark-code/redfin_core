<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSONL File Viewer - Column Based with Database Save</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
    <h1>JSONL File Viewer - Column Based with Database Save</h1>

    <!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
    <div th:if="${error}" class="error">
        <strong>ì˜¤ë¥˜:</strong> <span th:text="${error}"></span>
    </div>

    <!-- íŒŒì¼ ëª©ë¡ ì„¹ì…˜ -->
    <div class="section">
        <h3>íŒŒì¼ ëª©ë¡ (d:\data)</h3>
        <div th:if="${fileNames != null and !fileNames.empty}">
            <ul id="fileList">
                <li th:each="file : ${fileNames}">
                    <a th:href="@{/rss(fileName=${file})}" th:text="${file}"
                       th:class="${file == selectedFile} ? 'selected' : ''"></a>
                </li>
            </ul>
        </div>
        <div th:if="${fileNames == null or fileNames.empty}">
            <p>d:\data í´ë”ì— .jsonl íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- ì„ íƒëœ íŒŒì¼ì˜ ë°ì´í„° í…Œì´ë¸” -->
    <div th:if="${selectedFile != null and columns != null and data != null}" class="section">
        <h3>ë°ì´í„° í…Œì´ë¸”</h3>
        <div class="stats">
            <div class="stat-item">
                <strong th:text="${selectedFile}">íŒŒì¼ëª…</strong>
                <span>ì„ íƒëœ íŒŒì¼</span>
            </div>
            <div class="stat-item">
                <strong th:text="${totalRecords}">0</strong>
                <span>ì´ ë ˆì½”ë“œ ìˆ˜</span>
            </div>
            <div class="stat-item">
                <strong th:text="${#lists.size(columns)}">0</strong>
                <span>ì´ ì»¬ëŸ¼ ìˆ˜</span>
            </div>
        </div>

        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="column-filter">
            <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." onkeyup="filterTable()">
            <select id="columnSelect" onchange="filterByColumn()">
                <option value="">ëª¨ë“  ì»¬ëŸ¼</option>
                <option th:each="col : ${columns}" th:value="${col}" th:text="${col}"></option>
            </select>
            <button class="btn btn-secondary" onclick="exportTableToCSV()">CSV ë‚´ë³´ë‚´ê¸°</button>
        </div>

        <!-- ë°ì´í„° í…Œì´ë¸” -->
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th th:each="col : ${columns}" th:text="${col}"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="record : ${data}" th:data-row-index="${recordStat.index}">
                        <td th:each="col : ${columns}">
                            <span th:if="${record.get(col) != null}" th:text="${record.get(col)}"></span>
                            <span th:if="${record.get(col) == null}" class="null-value">NULL</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="table-info">
            <span class="record-count">
                ì´ <span th:text="${totalRecords}">0</span>ê°œ ë ˆì½”ë“œ ì¤‘
                <span th:text="${(currentPage-1) * pageSize + 1}">1</span>-<span th:text="${(currentPage-1) * pageSize + #lists.size(data)}">10</span>ê°œ í‘œì‹œ
                (í˜ì´ì§€ <span th:text="${currentPage}">1</span>/<span th:text="${totalPages}">1</span>)
            </span>
            <span class="column-count"><span th:text="${#lists.size(columns)}">0</span>ê°œ ì»¬ëŸ¼</span>
        </div>

        <!-- í˜ì´ì§• ë„¤ë¹„ê²Œì´ì…˜ -->
        <div th:if="${totalPages > 1}" class="pagination-container">
            <nav class="pagination">
                <!-- ì´ì „ í˜ì´ì§€ -->
                <a th:if="${hasPrev}"
                   th:href="@{/rss(fileName=${selectedFile}, page=${prevPage}, size=${pageSize})}"
                   class="pagination-btn">
                    &laquo; ì´ì „
                </a>
                <span th:unless="${hasPrev}" class="pagination-btn disabled">
                    &laquo; ì´ì „
                </span>

                <!-- í˜ì´ì§€ ë²ˆí˜¸ë“¤ -->
                <div class="page-numbers">
                    <!-- ì²« ë²ˆì§¸ í˜ì´ì§€ -->
                    <a th:if="${currentPage > 3}"
                       th:href="@{/rss(fileName=${selectedFile}, page=1, size=${pageSize})}"
                       class="pagination-btn">1</a>

                    <!-- ì ì ì  í‘œì‹œ -->
                    <span th:if="${currentPage > 4}" class="pagination-dots">...</span>

                    <!-- í˜„ì¬ í˜ì´ì§€ ì£¼ë³€ í˜ì´ì§€ë“¤ -->
                    <th:block th:each="pageNum : ${#numbers.sequence(T(java.lang.Math).max(1, currentPage - 2), T(java.lang.Math).min(totalPages, currentPage + 2))}">
                        <a th:if="${pageNum != currentPage}"
                           th:href="@{/rss(fileName=${selectedFile}, page=${pageNum}, size=${pageSize})}"
                           th:text="${pageNum}"
                           class="pagination-btn"></a>
                        <span th:if="${pageNum == currentPage}"
                              th:text="${pageNum}"
                              class="pagination-btn current"></span>
                    </th:block>

                    <!-- ì ì ì  í‘œì‹œ -->
                    <span th:if="${currentPage < totalPages - 3}" class="pagination-dots">...</span>

                    <!-- ë§ˆì§€ë§‰ í˜ì´ì§€ -->
                    <a th:if="${currentPage < totalPages - 2}"
                       th:href="@{/rss(fileName=${selectedFile}, page=${totalPages}, size=${pageSize})}"
                       th:text="${totalPages}"
                       class="pagination-btn"></a>
                </div>

                <!-- ë‹¤ìŒ í˜ì´ì§€ -->
                <a th:if="${hasNext}"
                   th:href="@{/rss(fileName=${selectedFile}, page=${nextPage}, size=${pageSize})}"
                   class="pagination-btn">
                    ë‹¤ìŒ &raquo;
                </a>
                <span th:unless="${hasNext}" class="pagination-btn disabled">
                    ë‹¤ìŒ &raquo;
                </span>
            </nav>
        </div>

        <!-- ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì„¹ì…˜ -->
        <div class="database-save-section">
            <h4>ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥</h4>
            <div class="save-controls">
                <div class="save-info">
                    <p><strong>ì„ íƒëœ íŒŒì¼:</strong> <span th:text="${selectedFile}">íŒŒì¼ëª…</span></p>
                    <p><strong>ì €ì¥ë  ë ˆì½”ë“œ ìˆ˜:</strong> <span th:text="${totalRecords}">0</span>ê°œ</p>
                </div>
                <div class="save-buttons">
                    <button class="btn btn-success btn-save"
                            th:data-filename="${selectedFile}"
                            onclick="saveToDatabase(this.getAttribute('data-filename'))">
                        <span class="btn-icon">ğŸ’¾</span>
                        ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
                    </button>
                    <button class="btn btn-secondary" onclick="showSaveConfirm()">
                        <span class="btn-icon">âš™ï¸</span>
                        ì €ì¥ ì˜µì…˜
                    </button>
                </div>
            </div>
            <div id="saveResult" style="display:none; margin-top: 15px;"></div>

            <!-- ì €ì¥ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ -->
            <div id="saveConfirmDialog" class="modal" style="display:none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5>ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ í™•ì¸</h5>
                        <button class="modal-close" onclick="hideSaveConfirm()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>ì„ íƒí•œ íŒŒì¼ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                        <div class="save-options">
                            <label>
                                <input type="checkbox" id="overwriteData" checked>
                                ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ê¸° í—ˆìš©
                            </label>
                            <label>
                                <input type="checkbox" id="createBackup">
                                ì €ì¥ ì „ ë°±ì—… ìƒì„±
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="hideSaveConfirm()">ì·¨ì†Œ</button>
                        <button class="btn btn-success"
                                th:data-filename="${selectedFile}"
                                onclick="confirmSaveToDatabase(this.getAttribute('data-filename'))">ì €ì¥ í™•ì¸</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API ì—”ë“œí¬ì¸íŠ¸ ì„¹ì…˜ -->
    <div class="section">
        <h3>API ì—”ë“œí¬ì¸íŠ¸</h3>
        <ul>
            <li><strong>GET /api/files/data</strong> - JSONL íŒŒì¼ ëª©ë¡</li>
            <li><strong>GET /api/files/data/{fileName}/columns</strong> - ì»¬ëŸ¼ ì •ë³´</li>
            <li><strong>GET /api/files/data/{fileName}/structured</strong> - êµ¬ì¡°í™”ëœ ë°ì´í„°</li>
            <li><strong>POST /api/files/data/{fileName}/save-to-db</strong> - ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥</li>
        </ul>
    </div>
</div>

<script>
// í…Œì´ë¸” í•„í„°ë§ í•¨ìˆ˜
function filterTable() {
    const searchInput = document.getElementById('searchInput');
    const table = document.getElementById('dataTable');

    if (!searchInput || !table) return;

    const filter = searchInput.value.toLowerCase();
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        let shouldShow = false;

        const cells = row.getElementsByTagName('td');
        for (let j = 0; j < cells.length; j++) {
            const cellText = cells[j].textContent || cells[j].innerText;
            if (cellText.toLowerCase().indexOf(filter) > -1) {
                shouldShow = true;
                break;
            }
        }

        row.style.display = shouldShow ? '' : 'none';
    }
}

// ì»¬ëŸ¼ë³„ í•„í„°ë§
function filterByColumn() {
    const columnSelect = document.getElementById('columnSelect');
    const table = document.getElementById('dataTable');

    if (!columnSelect || !table) return;

    const selectedColumn = columnSelect.value;
    const headerCells = table.querySelectorAll('thead th');
    const bodyRows = table.querySelectorAll('tbody tr');

    if (!selectedColumn) {
        // ëª¨ë“  ì»¬ëŸ¼ í‘œì‹œ
        headerCells.forEach(cell => cell.style.display = '');
        bodyRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => cell.style.display = '');
        });
        return;
    }

    // ì„ íƒëœ ì»¬ëŸ¼ë§Œ í‘œì‹œ
    let selectedIndex = -1;
    headerCells.forEach((cell, index) => {
        if (cell.textContent === selectedColumn) {
            selectedIndex = index;
            cell.style.display = '';
        } else {
            cell.style.display = 'none';
        }
    });

    bodyRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, index) => {
            if (index === selectedIndex) {
                cell.style.display = '';
            } else {
                cell.style.display = 'none';
            }
        });
    });
}

// CSV ë‚´ë³´ë‚´ê¸° - ê°œì„ ëœ ë²„ì „
function exportTableToCSV() {
    console.log('CSV ë‚´ë³´ë‚´ê¸° ì‹œì‘'); // ë””ë²„ê¹…ìš©

    const table = document.getElementById('dataTable');
    if (!table) {
        console.error('í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        alert('í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const rows = table.querySelectorAll('tr');
    if (rows.length === 0) {
        console.error('í…Œì´ë¸”ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    let csvContent = '';

    try {
        rows.forEach((row, index) => {
            const cells = row.querySelectorAll('th, td');
            const rowData = Array.from(cells).map(cell => {
                let text = cell.textContent.trim();
                // NULL ê°’ ì²˜ë¦¬
                if (text === 'NULL') {
                    text = '';
                }
                // CSV íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬
                if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                    text = `"${text.replace(/"/g, '""')}"`;
                }
                return text;
            });
            csvContent += rowData.join(',') + '\n';
            console.log(`í–‰ ${index + 1} ì²˜ë¦¬ ì™„ë£Œ`);
        });

        // íŒŒì¼ëª… ìƒì„±
        const selectedFile = document.querySelector('[data-filename]')?.getAttribute('data-filename') || 'data';
        const fileName = selectedFile.replace('.jsonl', '') + '_export.csv';

        // Blob ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);

        console.log('CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘:', fileName);
        link.click();

        // ì •ë¦¬
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        console.log('CSV ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');

        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        const message = document.createElement('div');
        message.className = 'success';
        message.innerHTML = `<strong>ì„±ê³µ!</strong> CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤: ${fileName}`;
        message.style.position = 'fixed';
        message.style.top = '20px';
        message.style.right = '20px';
        message.style.zIndex = '1000';
        message.style.padding = '10px';
        message.style.borderRadius = '5px';
        document.body.appendChild(message);

        setTimeout(() => {
            document.body.removeChild(message);
        }, 3000);

    } catch (error) {
        console.error('CSV ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜:', error);
        alert('CSV ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
function saveToDatabase(fileName) {
    const saveResult = document.getElementById('saveResult');
    const saveButton = document.querySelector('.btn-save');

    // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
    saveButton.disabled = true;
    saveButton.innerHTML = '<span class="btn-icon">â³</span>ì €ì¥ ì¤‘...';

    saveResult.innerHTML = '<p>ì €ì¥ ì¤‘...</p>';
    saveResult.style.display = 'block';

    console.log('Saving file:', fileName); // ë””ë²„ê¹…ìš©

    fetch(`/api/files/data/${encodeURIComponent(fileName)}/save-to-db`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        console.log('Response status:', response.status); // ë””ë²„ê¹…ìš©
        console.log('Response headers:', response.headers); // ë””ë²„ê¹…ìš©

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data); // ë””ë²„ê¹…ìš©

        if (data.success) {
            saveResult.innerHTML = `
                <div class="success">
                    <strong>ì„±ê³µ!</strong> ${data.message}<br>
                    ì €ì¥ëœ ë ˆì½”ë“œ ìˆ˜: ${data.savedRecords}
                </div>
            `;
        } else {
            saveResult.innerHTML = `
                <div class="error">
                    <strong>ì˜¤ë¥˜:</strong> ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        saveResult.innerHTML = `
            <div class="error">
                <strong>ì˜¤ë¥˜:</strong> ì €ì¥ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
                ìƒì„¸ ì˜¤ë¥˜: ${error.message}
            </div>
        `;
    })
    .finally(() => {
        // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        saveButton.disabled = false;
        saveButton.innerHTML = '<span class="btn-icon">ğŸ’¾</span>ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥';
    });
}

// ì €ì¥ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
function showSaveConfirm() {
    const dialog = document.getElementById('saveConfirmDialog');
    if (dialog) {
        dialog.style.display = 'block';
    }
}

// ì €ì¥ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ ìˆ¨ê¸°ê¸°
function hideSaveConfirm() {
    const dialog = document.getElementById('saveConfirmDialog');
    if (dialog) {
        dialog.style.display = 'none';
    }
}

// ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ í™•ì¸
function confirmSaveToDatabase(fileName) {
    const overwriteData = document.getElementById('overwriteData').checked;
    const createBackup = document.getElementById('createBackup').checked;

    const saveResult = document.getElementById('saveResult');
    const confirmButton = document.querySelector('.modal-footer .btn-success');

    // ë²„íŠ¼ ë¹„í™œì„±í™”
    confirmButton.disabled = true;
    confirmButton.innerHTML = 'ì €ì¥ ì¤‘...';

    saveResult.innerHTML = '<p>ì €ì¥ ì¤‘...</p>';
    saveResult.style.display = 'block';

    console.log('Confirming save with options:', { overwrite: overwriteData, backup: createBackup });

    fetch(`/api/files/data/${encodeURIComponent(fileName)}/save-to-db`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            overwrite: overwriteData,
            backup: createBackup
        })
    })
    .then(response => {
        console.log('Confirm response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Confirm response data:', data);

        hideSaveConfirm(); // ë‹¤ì´ì–¼ë¡œê·¸ ìˆ¨ê¸°ê¸°

        if (data.success) {
            saveResult.innerHTML = `
                <div class="success">
                    <strong>ì„±ê³µ!</strong> ${data.message}<br>
                    ì €ì¥ëœ ë ˆì½”ë“œ ìˆ˜: ${data.savedRecords}
                </div>
            `;
        } else {
            saveResult.innerHTML = `
                <div class="error">
                    <strong>ì˜¤ë¥˜:</strong> ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Confirm Error:', error);
        hideSaveConfirm();
        saveResult.innerHTML = `
            <div class="error">
                <strong>ì˜¤ë¥˜:</strong> ì €ì¥ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
                ìƒì„¸ ì˜¤ë¥˜: ${error.message}
            </div>
        `;
    })
    .finally(() => {
        // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        confirmButton.disabled = false;
        confirmButton.innerHTML = 'ì €ì¥ í™•ì¸';
    });
}
</script>
</body>
</html>
